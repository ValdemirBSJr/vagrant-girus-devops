###################
# COM VIRTUAL BOX #
###################

Vagrant.configure("2") do |config|
  # Usa uma box compatível com VirtualBox
  config.vm.box = "generic/ubuntu2204"

  # Define o provider como VirtualBox (opcional, pois é o padrão)
  config.vm.provider "virtualbox" do |vb|
    vb.name = "girus-vm"
    vb.memory = "4096"  # Recomendado para Kubernetes + Docker
    vb.cpus = 2
  end

  # Encaminhamento de portas: frontend e backend
  config.vm.network "forwarded_port", guest: 8000, host: 8000
  config.vm.network "forwarded_port", guest: 8080, host: 8080

  # Provisionamento via shell
  config.vm.provision "shell", inline: <<-SHELL
    #!/bin/bash
    
	echo ""
    echo ">>> Iniciando provisionamento..."

    # Atualiza os pacotes
    apt-get update -y

    echo ">>> Instalando pré-requisitos do Docker..."
    apt-get install -y ca-certificates curl gnupg

    # Adiciona chave GPG do Docker
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg

    # Adiciona repositório do Docker
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    apt-get update -y

    echo ">>> Instalando Docker Engine e plugins..."
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin net-tools

    # Adiciona usuário vagrant ao grupo docker
    usermod -aG docker vagrant

    echo ">>> Baixando e instalando o Girus..."
    su - vagrant -c "curl -sSL https://girus.linuxtips.io | bash"

    echo ">>> Garantindo que o port-forward do frontend esteja ativo..."
    su - vagrant -c "
      if ! pgrep -f 'kubectl.*8000.*girus-frontend' > /dev/null; then
        echo 'Iniciando port-forward do frontend (8000)...'
        nohup kubectl port-forward -n girus svc/girus-frontend 8000:80 --address 0.0.0.0 > /home/vagrant/girus-frontend.log 2>&1 &
      else
        echo 'Port-forward do frontend já está em execução.'
      fi
    "

    echo ">>> Garantindo que o port-forward do backend esteja ativo..."
    su - vagrant -c "
      if ! pgrep -f 'kubectl.*8080.*girus-backend' > /dev/null; then
        echo 'Iniciando port-forward do backend (8080)...'
        nohup kubectl port-forward -n girus svc/girus-backend 8080:80 --address 0.0.0.0 > /home/vagrant/girus-backend.log 2>&1 &
      else
        echo 'Port-forward do backend já está em execução.'
      fi
    "

    echo ">>> Provisionamento concluído!"
  SHELL
end
